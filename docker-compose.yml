services:
  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--bind", "0.0.0.0", "--protected-mode", "no"]
    networks:
      - nginx-oauth2-net
    restart: unless-stopped

  # OAuth2-proxy GENERAL (hub, sin filtro de grupos)
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: oauth2-proxy
    hostname: oauth2-proxy.srv-enodl-des-03.larioja.org
    environment:
      OAUTH2_PROXY_PROVIDER: "oidc"
      OAUTH2_PROXY_PROVIDER_DISPLAY_NAME: "ENO Data Lake SSO"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      OAUTH2_PROXY_REDIRECT_URL: "https://srv-enodl-des-03.larioja.org:444/oauth2/callback"

      # Cliente GENERAL (sin ALLOWED_GROUPS)
      OAUTH2_PROXY_CLIENT_ID: "oauth2-proxy"
      OAUTH2_PROXY_CLIENT_SECRET: "a6kdEcO1zEmT4CVYT3Z8yrsOB9qIVn9C"

      OAUTH2_PROXY_OIDC_ISSUER_URL: "http://keycloak:8080/realms/enodl-poc-des"
      OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION: "true"
      OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: "false"
      OAUTH2_PROXY_OIDC_EXTRA_AUDIENCES: "account"

      OAUTH2_PROXY_SCOPE: "openid email profile roles"
      OAUTH2_PROXY_USER_ID_CLAIM: "preferred_username"
      OAUTH2_PROXY_OIDC_USERNAME_CLAIM: "preferred_username"
      OAUTH2_PROXY_OIDC_EMAIL_CLAIM: "email"
      OAUTH2_PROXY_OIDC_GROUPS_CLAIM: "groups"
      OAUTH2_PROXY_GROUP_CLAIM_DELIMITER: ","
      OAUTH2_PROXY_PREFER_EMAIL_TO_USER: "false"

      OAUTH2_PROXY_PASS_GROUP_HEADERS: "true"
      OAUTH2_PROXY_OIDC_GROUPS_HEADER: "X-Auth-Request-Groups"

      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL: "true"

      # Cookie del hub general
      OAUTH2_PROXY_COOKIE_SECRET: "0123456789abcdef0123456789abcdef"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_COOKIE_DOMAINS: "srv-enodl-des-03.larioja.org"
      OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy"
      OAUTH2_PROXY_COOKIE_EXPIRE: "168h"
      OAUTH2_PROXY_COOKIE_REFRESH: "0s"
      OAUTH2_PROXY_SESSION_STORE_TYPE: "redis"
      OAUTH2_PROXY_REDIS_CONNECTION_URL: "redis://redis:6379"

      # NO pasar tokens (reduce tamaño de cookie)
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "false"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "false"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "false"

      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_REDEEM_REFRESH: "false"
      OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY: "false"
      OAUTH2_PROXY_PROVIDER_CA_FILES: "/certs/ca-cert.pem"

      OAUTH2_PROXY_PROXY_PREFIX: "/oauth2"
      OAUTH2_PROXY_SKIP_AUTH_ROUTES: "^/oauth2/health$,^/oauth2/ping$"

      # Forzar reautenticación e IdP CAS en cada login
      OAUTH2_PROXY_OIDC_EXTRA_PARAMS: "kc_idp_hint=cas-larioja&prompt=login"

      OAUTH2_PROXY_REQUEST_LOGGING: "true"
      OAUTH2_PROXY_AUTH_LOGGING: "true"
      OAUTH2_PROXY_STANDARD_LOGGING: "true"
      OAUTH2_PROXY_LOG_LEVEL: "info"

      OAUTH2_PROXY_WHITELIST_DOMAIN: "srv-enodl-des-03.larioja.org,desarrollo.larioja.org,.larioja.org"

    volumes:
      - ./certs/ca/ca-cert.pem:/certs/ca-cert.pem:ro
    extra_hosts:
      - "srv-enodl-des-03.larioja.org:host-gateway"
    networks:
      - nginx-oauth2-net
    restart: unless-stopped
    depends_on:
      keycloak:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:4180/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 90s

  # oauth2-proxy-ambari:
  #   image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
  #   container_name: oauth2-proxy-ambari
  #   hostname: oauth2-proxy-ambari.srv-enodl-des-03.larioja.org
  #   environment:
  #     OAUTH2_PROXY_PROVIDER: "oidc"
  #     OAUTH2_PROXY_PROVIDER_DISPLAY_NAME: "Ambari SSO"
  #     OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      
  #     # Prefix diferente para no colisionar con oauth2-proxy general
  #     OAUTH2_PROXY_PROXY_PREFIX: "/oauth2-ambari"
  #     OAUTH2_PROXY_REDIRECT_URL: "https://srv-enodl-des-03.larioja.org:445/oauth2-ambari/callback"

  #     # Cliente AMBARI (con ALLOWED_GROUPS)
  #     OAUTH2_PROXY_CLIENT_ID: "oauth2-proxy-ambari"
  #     OAUTH2_PROXY_CLIENT_SECRET: "4TIjzxWXNis6AzhEUg02RULHfcTNk8li"

  #     OAUTH2_PROXY_OIDC_ISSUER_URL: "http://keycloak:8080/realms/enodl-poc-des"
  #     OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION: "true"
  #     OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: "false"
  #     OAUTH2_PROXY_OIDC_EXTRA_AUDIENCES: "account"

  #     OAUTH2_PROXY_SCOPE: "openid email profile roles"
  #     OAUTH2_PROXY_USER_ID_CLAIM: "preferred_username"
  #     OAUTH2_PROXY_OIDC_USERNAME_CLAIM: "preferred_username"
  #     OAUTH2_PROXY_OIDC_GROUPS_CLAIM: "groups"
  #     OAUTH2_PROXY_GROUP_CLAIM_DELIMITER: ","

  #     # FILTRO DE GRUPOS (solo ambari-admin o ambari-user)
  #     OAUTH2_PROXY_ALLOWED_GROUPS: "ambari-admin,ambari-user"

  #     OAUTH2_PROXY_PASS_GROUP_HEADERS: "true"
  #     OAUTH2_PROXY_OIDC_GROUPS_HEADER: "X-Auth-Request-Groups"

  #     OAUTH2_PROXY_EMAIL_DOMAINS: "*"
  #     OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL: "true"

  #     # Cookie DIFERENTE (para que no colisione con la del hub)
  #     OAUTH2_PROXY_COOKIE_SECRET: "0123456789abcdef0123456789abcdef"
  #     OAUTH2_PROXY_COOKIE_SECURE: "true"
  #     OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
  #     OAUTH2_PROXY_COOKIE_DOMAINS: "srv-enodl-des-03.larioja.org"
  #     OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy_ambari"
  #     OAUTH2_PROXY_COOKIE_EXPIRE: "168h"
  #     OAUTH2_PROXY_COOKIE_REFRESH: "0s"
  #     OAUTH2_PROXY_SESSION_STORE_TYPE: "redis"
  #     OAUTH2_PROXY_REDIS_CONNECTION_URL: "redis://redis:6379"

  #     OAUTH2_PROXY_PASS_ACCESS_TOKEN: "false"
  #     OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "false"
  #     OAUTH2_PROXY_PASS_USER_HEADERS: "true"
  #     OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
  #     OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "false"

  #     OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
  #     OAUTH2_PROXY_REDEEM_REFRESH: "false"
  #     OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY: "false"
  #     OAUTH2_PROXY_PROVIDER_CA_FILES: "/certs/ca-cert.pem"

  #     OAUTH2_PROXY_SKIP_AUTH_ROUTES: "^/oauth2-ambari/health$,^/oauth2-ambari/ping$"

  #     OAUTH2_PROXY_REQUEST_LOGGING: "true"
  #     OAUTH2_PROXY_AUTH_LOGGING: "true"
  #     OAUTH2_PROXY_STANDARD_LOGGING: "true"
  #     OAUTH2_PROXY_LOG_LEVEL: "info"

  #     OAUTH2_PROXY_WHITELIST_DOMAIN: ".larioja.org,srv-enodl-des-03.larioja.org"

  knox:
    image: farberg/apache-knox-docker:1.6.1
    container_name: knox
    hostname: knox
    environment:
      JAVA_TOOL_OPTIONS: "-Dgateway.hadoop.kerberos.secured=true"
      KNOX_GATEWAY_DBG_OPTS: "-Dgateway.hadoop.kerberos.secured=true"
    volumes:
      - ./knox/topologies:/opt/knox-1.6.1/conf/topologies:ro
      - ./knox/conf/gateway-site.xml:/opt/knox-1.6.1/conf/gateway-site.xml:ro
      - ./knox/conf/krb5.conf:/opt/knox-1.6.1/conf/krb5.conf:ro
      - ./knox/conf/krb5JAASLogin.conf:/opt/knox-1.6.1/conf/krb5JAASLogin.conf:ro
      - ./knox/data/security:/opt/knox-1.6.1/data/security
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "srv-enodl-des-03.larioja.org:host-gateway"
    networks:
      - nginx-oauth2-net
    restart: unless-stopped
    depends_on:
      keycloak:
        condition: service_healthy

  ldap-admin-ui:
    build:
      context: ./ldap-admin-ui
    container_name: ldap-admin-ui
    hostname: ldap-admin-ui
    environment:
      LDAP_URL: "ldaps://172.16.99.252:636"
      LDAP_BIND_DN: "cn=admin,dc=larioja,dc=org"
      LDAP_BIND_PASSWORD: "admin"
      LDAP_BASE_DN: "dc=larioja,dc=org"
      LDAP_PEOPLE_DN_BASE: "ou=people,dc=larioja,dc=org"
      LDAP_GROUPS_DN_BASE: "ou=groups,dc=larioja,dc=org"
      LDAP_TLS_CA_FILE: "/home/drodriguezlr.ext/docker-services/nginx-hub/certs/ca/ca-cert.pem"
      LDAP_TLS_INSECURE: "false"
      LDAP_CACHE_TTL: "60"
      NODE_ENV: "production"
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
      SYNC_REDIS_URL: "redis://redis:6379"
    volumes:
      - /home/drodriguezlr.ext/docker-services/nginx-hub/certs/ca/ca-cert.pem:/home/drodriguezlr.ext/docker-services/nginx-hub/certs/ca/ca-cert.pem:ro
    expose:
      - "3000"
    networks:
      - nginx-oauth2-net
    restart: unless-stopped
    depends_on:
      - openldap

  sync-worker:
    build:
      context: ./sync-worker
    container_name: sync-worker
    environment:
      SYNC_REDIS_URL: "redis://redis:6379"
      SYNC_WORKER_POLL_SECONDS: "5"
      SYNC_WORKER_RETRY_SECONDS: "60"

      SYNC_SSH_USER: "ldap-sync"
      SYNC_SSH_KEY_PATH: "/ssh/id_ed25519"

      SYNC_AMBARI_HOST: "172.16.99.230"
      SYNC_RANGER_HOST: "172.16.99.251"
      SYNC_HUE_HOST: "192.168.1.3"

      SYNC_KEY_DIRTY_HUE: "sync:dirty:hue"
      SYNC_KEY_HUE_DIRTY_GROUPS: "sync:hue:groups"
      SYNC_HUE_COMMAND_PREFIX: "sudo -n -u hue /usr/odp/current/hue-server/build/env/bin/hue import_ldap_group --import-members"

      SYNC_HUE_SUPERUSER_RECONCILE_ENABLED: "1"
      SYNC_HUE_SUPERUSER_GROUP: "hue_admin"

      SYNC_AMBARI_COMMAND: "sudo -n /sbin/ambari-server sync-ldap --all"
      SYNC_AMBARI_ADMIN_USER: "admin"
      SYNC_AMBARI_ADMIN_PASSWORD: "admin"
      SYNC_RANGER_ADMIN_URL: "http://172.16.99.251:6080"
      SYNC_RANGER_ADMIN_USER: "admin"
      SYNC_RANGER_ADMIN_PASSWORD: "Ambari.2025*"

      SYNC_RANGER_STOP_COMMAND: ""
      SYNC_RANGER_START_COMMAND: ""
      SYNC_RANGER_STATUS_COMMAND: ""
      SYNC_RANGER_RESTART_COMMAND: "sudo -n -u ranger /usr/odp/current/ranger-usersync/ranger-usersync-services.sh restart"
    volumes:
      - ./sync-worker/ssh:/ssh:ro
    networks:
      - nginx-oauth2-net
    restart: unless-stopped
    depends_on:
      - redis

  nginx:
    image: nginx:1.25-alpine
    container_name: nginx-poc
    hostname: srv-enodl-des-03.larioja.org
    volumes:
      - ./nginx-oauth2/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-oauth2/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs/nginx/cert.pem:/etc/nginx/certs/cert.pem:ro
      - ./certs/nginx/key.pem:/etc/nginx/certs/key.pem:ro
      - ./certs/nginx/fullchain.pem:/etc/nginx/certs/fullchain.pem:ro
      - ./certs/ca/ca-cert.pem:/etc/nginx/certs/ca-cert.pem:ro
      - ./certs/ldap/cert.pem:/etc/nginx/ldaps/cert.pem:ro
      - ./certs/ldap/key.pem:/etc/nginx/ldaps/key.pem:ro
      - ./certs/ldap/ca-cert.pem:/etc/nginx/ldaps/ca-cert.pem:ro
      - ./nginx-oauth2/html/index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx-oauth2/logs:/var/log/nginx
    ports:
      - "80:80"
      - "444:443" # Hub 
      - "445:445" # AMBARI
      - "446:446" # RANGER
      - "447:447" # HUE
      - "400:400" # LDAP Admin UI
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - nginx-oauth2-net
    depends_on:
      - oauth2-proxy
      - knox
      - ldap-admin-ui
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.5
    hostname: keycloak
    container_name: keycloak
    command:
      - start
      - --https-port=8443
      - --https-certificate-file=/opt/keycloak/conf/cert.pem
      - --https-certificate-key-file=/opt/keycloak/conf/key.pem
      - --hostname=srv-enodl-des-03.larioja.org
      - --hostname-strict=false
      - --http-enabled=true
      - --http-port=8080
      - --proxy=edge
      - --log-level=INFO
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME: srv-enodl-des-03.larioja.org
      KC_HOSTNAME_PORT: 8443
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_ADMIN: srv-enodl-des-03.larioja.org
      KC_PROXY: edge
      KC_HTTP_ENABLED: "true"
      KC_DB: dev-file
      KC_DB_URL_PATH: /opt/keycloak/data/keycloakdb
      JAVA_OPTS_APPEND: >
        -Xms512m
        -Xmx1024m
        -XX:MaxMetaspaceSize=256m
        -Djava.net.preferIPv4Stack=true
        -Djavax.net.ssl.trustStore=/opt/keycloak/conf/truststore.p12
        -Djavax.net.ssl.trustStorePassword=changeit
        -Djavax.net.ssl.trustStoreType=PKCS12
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    ports:
      - "8081:8080"
      - "8443:8443"
    volumes:
      - ./keycloak/data:/opt/keycloak/data:Z
      - ./keycloak/enodl:/opt/keycloak/themes/enodl:ro
      - ./certs/keycloak/cert.pem:/opt/keycloak/conf/cert.pem:ro
      - ./certs/keycloak/key.pem:/opt/keycloak/conf/key.pem:ro
      - ./certs/ca/ca-cert.pem:/opt/keycloak/conf/ca-cert.pem:ro
      - ./certs/ca/truststore.p12:/opt/keycloak/conf/truststore.p12:Z
    networks:
      - nginx-oauth2-net
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      - openldap

  openldap:
    build:
      context: ./ldap
      dockerfile: Dockerfile
    image: openldap-poc:1.0
    container_name: openldap-poc
    hostname: ldap.srv-enodl-des-03.larioja.org
    ports:
      - "636:636"
    environment:
      LDAP_ORGANISATION: "ENO Data Lake"
      LDAP_DOMAIN: "larioja.org"
      LDAP_BASE_DN: "dc=larioja,dc=org"
      LDAP_ADMIN_PASSWORD: "admin"
      LDAP_CONFIG_PASSWORD: "config_admin"
      LDAP_TLS: "true"
      LDAP_TLS_ENFORCE: "true"
      LDAP_TLS_CRT_FILENAME: "fullchain.pem"
      LDAP_TLS_KEY_FILENAME: "key.pem"
      LDAP_TLS_CA_CRT_FILENAME: "ca-cert.pem"
      LDAP_TLS_VERIFY_CLIENT: "never"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "false"
      LDAP_MEMBEROF_OVERLAY: "true"
      LDAP_MEMBEROF_REFINT: "true"
    volumes:
      - ./ldap/data/ldap:/var/lib/ldap:Z
      #- ./ldap/data/slapd:/etc/ldap/slapd.d:Z
      - ./ldap/ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom:Z
      - ./certs/ldap:/container/service/slapd/assets/certs
    networks:
      - nginx-oauth2-net
    restart: unless-stopped

networks:
  nginx-oauth2-net:
    driver: bridge

# ┌─ USUARIO
# │
# ├─> https ──> nginx + oauth2 :444
# │              │
# │              └─> solicita login ──> Keycloak :8443
# │                                        │
# │              ┌─ cookie _oauth2_proxy ──┤
# │              │                         │
# │              │    ┌─ cookie KEYCLOAK_SESSION (importante!)
# │              ↓    ↓
# │         nginx :444 (autenticado)
# │
# │
# ├─> https ──> nginx :445 (ambari)
# │              │
# │              └─> proxy ──> ambari :9090 (des-01)
# │                              │
# │                              └─> no hay hadoop-jwt
# │                                   │
# │                                   └─> redirect 302 ──> Knox :444/knoxsso/...
# │                                                            │
# │                                                            └─> Knox hace OIDC a Keycloak
# │                                                                │
# │              ┌─ Knox REUTILIZA cookie KEYCLOAK_SESSION ────────┘
# │              │  (NO pide login de nuevo!)
# │              │
# │              └─ Knox recibe tokens de Keycloak
# │                   │
# │                   └─> Knox firma JWT y setea cookie hadoop-jwt
# │                        │
# │                        └─> redirect 302 ──> nginx :445
# │                                               │
# │                                               └─> ambari :9090 (con hadoop-jwt)
# │                                                    │
# └─────────────────────────────────────────────────> Ambari carga ✓