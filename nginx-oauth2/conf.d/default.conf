upstream oauth2_proxy_upstream {
    server oauth2-proxy:4180;
    keepalive 16;
}

## LEGACY (deshabilitado): oauth2-proxy dedicado por servicio
#upstream oauth2_proxy_ambari_upstream {
#    server oauth2-proxy-ambari:4180;
#    keepalive 16;
#}
#
#upstream oauth2_proxy_ranger_upstream {
#    server oauth2-proxy-ranger:4180;
#    keepalive 16;
#}

server {
    listen 80;
    server_name srv-enodl-des-03.larioja.org;

    location / {
        return 301 https://$server_name:444$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name srv-enodl-des-03.larioja.org;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;
    ssl_trusted_certificate /etc/nginx/certs/ca-cert.pem;

    root /usr/share/nginx/html;

    set $forwarded_port $server_port;
    if ($http_host ~* ":(\\d+)$") { set $forwarded_port $1; }

    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    large_client_header_buffers 4 32k;

    # ============================================
    # OAuth2-proxy GENERAL (hub)
    # ============================================
    location = /oauth2/auth {
        internal;
        proxy_pass http://oauth2_proxy_upstream/oauth2/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        proxy_buffer_size 64k;
        proxy_buffers 8 64k;
        proxy_busy_buffers_size 128k;
    }

    location = /oauth2/callback {
        proxy_pass http://oauth2_proxy_upstream/oauth2/callback;
        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_buffer_size 256k;
        proxy_buffers 16 256k;
        proxy_busy_buffers_size 512k;
    }

    location /oauth2/ {
        proxy_pass http://oauth2_proxy_upstream;
        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_buffer_size 64k;
        proxy_buffers 8 64k;
        proxy_busy_buffers_size 128k;
    }

    # Publicar KnoxSSO (oculto) para Ambari
    location /knoxsso/ {
        proxy_pass https://knox:8443/gateway/knoxsso/;
        proxy_ssl_server_name on;
        proxy_ssl_name $host;
        proxy_ssl_verify off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
        
        proxy_cookie_path /gateway/knoxsso/api/v1 /;
        proxy_cookie_path /gateway/knoxsso/api/v1/ /;
        proxy_cookie_path /gateway/knoxsso /;
        proxy_cookie_path /gateway/knoxsso/ /;
        proxy_cookie_path /gateway /;
        proxy_cookie_path /gateway/ /;
        proxy_cookie_path /knoxsso/api/v1 /;
        proxy_cookie_path /knoxsso/api/v1/ /;

        proxy_redirect ~^(/gateway/knoxsso/)(.*)$ /knoxsso/$2;
        proxy_redirect ~^https://srv-enodl-des-03\.larioja\.org:444/gateway/knoxsso/(.*)$ https://srv-enodl-des-03.larioja.org:444/knoxsso/$1;
        
        # Buffers grandes para headers OIDC (Location con state/nonce)
        proxy_buffer_size 128k;
        proxy_buffers 8 128k;
        proxy_busy_buffers_size 256k;
    }

    # Manejar redirects internos de Knox que usan /gateway/knoxsso/
    location /gateway/knoxsso/ {
        proxy_pass https://knox:8443/gateway/knoxsso/;
        proxy_ssl_server_name on;
        proxy_ssl_name $host;
        proxy_ssl_verify off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
        
        proxy_cookie_path /gateway/knoxsso/api/v1 /;
        proxy_cookie_path /gateway/knoxsso/api/v1/ /;
        proxy_cookie_path /gateway/knoxsso /;
        proxy_cookie_path /gateway/knoxsso/ /;
        proxy_cookie_path /gateway /;
        proxy_cookie_path /gateway/ /;
        proxy_cookie_path /knoxsso/api/v1 /;
        proxy_cookie_path /knoxsso/api/v1/ /;

        proxy_redirect ~^(/gateway/knoxsso/)(.*)$ /knoxsso/$2;
        proxy_redirect ~^https://srv-enodl-des-03\.larioja\.org:444/gateway/knoxsso/(.*)$ https://srv-enodl-des-03.larioja.org:444/knoxsso/$1;
        
        proxy_buffer_size 128k;
        proxy_buffers 8 128k;
        proxy_busy_buffers_size 256k;
    }

    # ============================================
    # Hub protegido (root)
    # ============================================
    location / {
        auth_request /oauth2/auth;
        error_page 401 = @oauth2_login;

        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        try_files $uri $uri/ /index.html;
    }

    location = /sso/ambari {
        auth_request /oauth2/auth;
        error_page 401 = @oauth2_login;
        return 302 https://$host:444/knoxsso/api/v1/websso?originalUrl=https%3A%2F%2Fsrv-enodl-des-03.larioja.org%3A445%2F;
    }

    location = /sso/ranger {
        auth_request /oauth2/auth;
        error_page 401 = @oauth2_login;
        return 302 https://$host:444/knoxsso/api/v1/websso?originalUrl=https%3A%2F%2Fsrv-enodl-des-03.larioja.org%3A446%2F;
    }

    location = /sso/hue {
        auth_request /oauth2/auth;
        error_page 401 = @oauth2_login;
        return 302 https://$host:444/knoxsso/api/v1/websso?originalUrl=https%3A%2F%2Fsrv-enodl-des-03.larioja.org%3A447%2F;
    }

    location @oauth2_login {
        internal;
        return 302 https://$server_name:444/oauth2/start?rd=$scheme://$http_host$request_uri;
    }

    location = /logout {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header Clear-Site-Data '"cache","cookies","storage"' always;

        add_header Set-Cookie "_oauth2_proxy=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy=deleted; Path=/; Domain=.srv-enodl-des-03.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy_csrf=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy_csrf=deleted; Path=/; Domain=.srv-enodl-des-03.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy_csrf=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "_oauth2_proxy_csrf=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;

        add_header Set-Cookie "KEYCLOAK_SESSION=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "KEYCLOAK_SESSION_LEGACY=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly" always;
        add_header Set-Cookie "KEYCLOAK_IDENTITY=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "KEYCLOAK_IDENTITY_LEGACY=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly" always;
        add_header Set-Cookie "KC_RESTART=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID_LEGACY=deleted; Path=/realms/enodl-poc-des/; Max-Age=0; Secure; HttpOnly" always;
        add_header Set-Cookie "KC_RESTART=deleted; Path=/realms/enodl-poc-des/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID=deleted; Path=/realms/enodl-poc-des/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID_LEGACY=deleted; Path=/realms/enodl-poc-des/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly" always;
        add_header Set-Cookie "KC_RESTART=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "KC_RESTART=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "KC_RESTART=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=None" always;
        add_header Set-Cookie "AUTH_SESSION_ID_LEGACY=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly" always;
        add_header Set-Cookie "AUTH_SESSION_ID_LEGACY=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly" always;
        add_header Set-Cookie "AUTH_SESSION_ID_LEGACY=deleted; Path=/; Max-Age=0; Secure; HttpOnly" always;

        add_header Set-Cookie "hadoop-jwt=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "hadoop-jwt=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "hadoop-jwt=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "hadoop-jwt=deleted; Path=/gateway; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "hadoop-jwt=deleted; Path=/gateway/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "hadoop-jwt=deleted; Path=/gateway/knoxsso; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "hadoop-jwt=deleted; Path=/gateway/knoxsso/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "JSESSIONID=deleted; Path=/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "JSESSIONID=deleted; Path=/; Domain=.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "JSESSIONID=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "JSESSIONID=deleted; Path=/gateway; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "JSESSIONID=deleted; Path=/gateway/; Domain=srv-enodl-des-03.larioja.org; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4jSession=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "PAC4JSESSION=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jCsrfToken=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jRequestedUrl=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jUserProfiles=deleted; Path=/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jCsrfToken=deleted; Path=/knoxsso/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jRequestedUrl=deleted; Path=/knoxsso/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jUserProfiles=deleted; Path=/knoxsso/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jCsrfToken=deleted; Path=/knoxsso/api/v1; Domain=.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jRequestedUrl=deleted; Path=/knoxsso/api/v1; Domain=.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jUserProfiles=deleted; Path=/knoxsso/api/v1; Domain=.larioja.org; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jCsrfToken=deleted; Path=/gateway/knoxsso/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jRequestedUrl=deleted; Path=/gateway/knoxsso/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "pac4j.session.pac4jUserProfiles=deleted; Path=/gateway/knoxsso/; Max-Age=0; Secure; HttpOnly; SameSite=Lax" always;
        add_header Set-Cookie "RANGERADMINSESSIONID=deleted; Path=/; Max-Age=0; Secure" always;
        add_header Set-Cookie "AMBARISESSIONID=deleted; Path=/; Max-Age=0; Secure" always;
        add_header Set-Cookie "pac4jCsrfToken=deleted; Path=/; Max-Age=0; Secure" always;
        add_header Set-Cookie "clientTimeOffset=deleted; Path=/; Max-Age=0" always;

        return 302 https://$server_name:444/oauth2/sign_out?rd=/post-logout;
    }

    location = /post-logout {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        return 302 https://desarrollo.larioja.org/casLR/logout?service=https%3A%2F%2Fsrv-enodl-des-03.larioja.org%3A444%2Foauth2%2Fstart%3Frd%3Dhttps%253A%252F%252Fsrv-enodl-des-03.larioja.org%253A444%252F%253Flogged_out%253D1;
    }
}

# ============================================
# LDAP Admin UI (puerto 400)
# ============================================
server {
    listen 400 ssl http2;
    server_name srv-enodl-des-03.larioja.org;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;
    ssl_trusted_certificate /etc/nginx/certs/ca-cert.pem;

    set $forwarded_port $server_port;
    if ($http_host ~* ":(\\d+)$") { set $forwarded_port $1; }

    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    large_client_header_buffers 4 32k;

    location = /oauth2/auth {
        internal;
        proxy_pass http://oauth2_proxy_upstream/oauth2/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        proxy_buffer_size 64k;
        proxy_buffers 8 64k;
        proxy_busy_buffers_size 128k;
    }

    location = /oauth2/callback {
        proxy_pass http://oauth2_proxy_upstream/oauth2/callback;
        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_buffer_size 256k;
        proxy_buffers 16 256k;
        proxy_busy_buffers_size 512k;
    }

    location /oauth2/ {
        proxy_pass http://oauth2_proxy_upstream;
        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
        proxy_buffer_size 64k;
        proxy_buffers 8 64k;
        proxy_busy_buffers_size 128k;
    }

    location @oauth2_login {
        internal;
        return 302 https://$server_name:444/oauth2/start?rd=$scheme://$http_host$request_uri;
    }

    location / {
        auth_request /oauth2/auth;
        error_page 401 = @oauth2_login;

        # Seguridad: nunca confiar en cabeceras X-Auth-Request-* que pueda enviar el cliente.
        # Las vaciamos explícitamente y luego las seteamos desde el subrequest de oauth2-proxy.
        proxy_set_header X-Auth-Request-User "";
        proxy_set_header X-Auth-Request-Groups "";
        proxy_set_header X-Auth-Request-Email "";

        auth_request_set $auth_user $upstream_http_x_auth_request_user;
        auth_request_set $auth_groups $upstream_http_x_auth_request_groups;
        auth_request_set $auth_email $upstream_http_x_auth_request_email;

        proxy_set_header X-Auth-Request-User $auth_user;
        proxy_set_header X-Auth-Request-Groups $auth_groups;
        proxy_set_header X-Auth-Request-Email $auth_email;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;

        proxy_pass http://ldap-admin-ui:3000;
    }

    location = /logout { return 302 https://$host:444/logout; }
}


# ============================================
# AMBARI (puerto 445 externo)
# ============================================
server {
    listen 445 ssl http2;
    server_name srv-enodl-des-03.larioja.org;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;
    ssl_trusted_certificate /etc/nginx/certs/ca-cert.pem;

    set $forwarded_port $server_port;
    if ($http_host ~* ":(\\d+)$") { set $forwarded_port $1; }

    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    large_client_header_buffers 4 32k;

    # Permitir login local de Ambari sin oauth2-proxy
    location = /api/v1/auth {

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;

        proxy_pass http://srv-enodl-des-01.larioja.org:9090;
    }

    location ^~ /api/v1/ {
        access_log off;

        proxy_set_header Host $host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;

        proxy_pass http://srv-enodl-des-01.larioja.org:9090;
    }

    location ^~ /events/ {
        access_log off;

        proxy_set_header Host $host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://srv-enodl-des-01.larioja.org:9090;
    }

    location / {
        proxy_set_header Host $host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_pass http://srv-enodl-des-01.larioja.org:9090;
    }

    location = /logout { return 302 https://$host:444/logout; }

    ## LEGACY (deshabilitado): oauth2-proxy-ambari
    #location = /internal/oauth2-ambari/auth {
    #    internal;
    #
    #    proxy_pass http://oauth2_proxy_ambari_upstream/oauth2-ambari/auth;
    #    proxy_pass_request_body off;
    #    proxy_set_header Content-Length "";
    #
    #    proxy_set_header Host $host;
    #    proxy_set_header Cookie $http_cookie;
    #    proxy_set_header Authorization $http_authorization;
    #
    #    proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header X-Forwarded-Proto $scheme;
    #    proxy_set_header X-Forwarded-Host $host;
    #    proxy_set_header X-Forwarded-Port $forwarded_port;
    #
    #    proxy_connect_timeout 2s;
    #    proxy_read_timeout 5s;
    #}
    #
    #location /oauth2-ambari/ {
    #    proxy_pass http://oauth2_proxy_ambari_upstream;
    #    proxy_set_header Host $host;
    #    proxy_set_header Cookie $http_cookie;
    #    proxy_set_header X-Real-IP $remote_addr;
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header X-Forwarded-Proto $scheme;
    #    proxy_set_header X-Forwarded-Host $host;
    #    proxy_set_header X-Forwarded-Port $forwarded_port;
    #
    #    proxy_buffer_size 64k;
    #    proxy_buffers 8 64k;
    #    proxy_busy_buffers_size 128k;
    #}
    #
    #location @ambari_login {
    #    internal;
    #    return 302 https://$host:$forwarded_port/oauth2-ambari/start?rd=$request_uri;
    #}
    #
    #location @ambari_forbidden {
    #    internal;
    #    default_type text/plain;
    #    return 403 "Access Denied: you need ambari-admin or ambari-user group\n";
    #}
}

# ============================================
# RANGER (puerto 446 externo)
# ============================================
server {
    listen 446 ssl http2;
    server_name srv-enodl-des-03.larioja.org;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;
    ssl_trusted_certificate /etc/nginx/certs/ca-cert.pem;

    set $forwarded_port 446;

    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    large_client_header_buffers 4 32k;

    # Proxy pass a Ranger (ajusta el host/puerto según tu instalación)
    # Normalmente Ranger corre en puerto 6080 (HTTP) o 6182 (HTTPS)
    location / {
        proxy_set_header Host $host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;

        proxy_pass http://srv-enodl-des-02.larioja.org:6080;
    }

    location = /logout { return 302 https://$host:444/logout; }
}

# ============================================
# HUE (puerto 447 externo)
# ============================================
server {
    listen 447 ssl http2;
    server_name srv-enodl-des-03.larioja.org;

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;
    ssl_trusted_certificate /etc/nginx/certs/ca-cert.pem;

    set $forwarded_port 447;

    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;

    large_client_header_buffers 4 32k;

    location ~ ^/gateway/hue/hue/(.*)$ {
        return 302 /$1;
    }

    location = /gateway/hue/hue {
        return 302 /;
    }

    location / {
        if ($http_cookie !~* "hadoop-jwt=") {
            return 302 https://$host:444/sso/hue;
        }

        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_buffering off;

        proxy_ssl_server_name on;
        proxy_ssl_name $host;
        proxy_ssl_verify off;

        proxy_cookie_path /gateway/hue/hue/ /;
        proxy_cookie_path /gateway/hue/hue /;

        proxy_redirect ~^(/gateway/hue/hue/)(.*)$ /$2;
        proxy_redirect ~^(/gateway/hue/hue)(.*)$ /$2;
        proxy_redirect ~^https?://[^/]+/gateway/hue/hue/(.*)$ /$1;
        proxy_redirect ~^https?://[^/]+/gateway/hue/hue$ /;
        proxy_redirect ~^https?://[^/]+/gateway/hue/hue$ /;
        proxy_redirect ~^https?://[^/]+/gateway/hue/hue/?$ /;

        proxy_set_header Accept-Encoding "";
        sub_filter_once off;
        sub_filter_types text/html application/javascript text/css;
        sub_filter "/gateway/hue/hue/" "/";
        sub_filter "/gateway/hue/hue" "/";

        set $knox_hue_uri /gateway/hue/hue$request_uri;
        proxy_pass https://knox:8443$knox_hue_uri;
    }

    location = /logout { return 302 https://$host:444/logout; }
}